local RunService = game:GetService('RunService')
local PlayerService = game:GetService('Players')
local Teams = game:GetService('Teams')

local LocalPlayer = PlayerService.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild('HumanoidRootPart')
local Camera = workspace.CurrentCamera

-- Функция для проверки, является ли игрок тиммейтом
local function IsTeammate(player)
    if not player.Team then return false end
    return player.Team == LocalPlayer.Team
end

local function ESP(player)
    local ESPConnection
    local Drawings = {
        Box = Drawing.new('Square'),
        BoxOutline = Drawing.new('Square'),
    }

    -- Настройка первоначальных свойств
    for _, drawing in pairs(Drawings) do
        drawing.Visible = false
        drawing.Filled = false
    end

    Drawings.BoxOutline.Thickness = 3
    Drawings.Box.Thickness = 1

    local function UpdateESP()
        ESPConnection = RunService.RenderStepped:Connect(function()
            if not player or not player.Parent then
                ESPConnection:Disconnect()
                for _, drawing in pairs(Drawings) do
                    drawing:Remove()
                end
                return
            end

            local Character = player.Character
            if Character then
                local RootPart = Character:FindFirstChild('HumanoidRootPart')
                if RootPart then
                    local Position, OnScreen = Camera:WorldToViewportPoint(RootPart.Position)
                    
                    if OnScreen then
                        -- Определяем цвет в зависимости от команды
                        local color = IsTeammate(player) and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
                        
                        local scale = 1 / (Position.Z * math.tan(math.rad(Camera.FieldOfView * 0.5)) * 2) * 1000
                        local width, height = math.floor(4.5 * scale), math.floor(6 * scale)
                        local x, y = math.floor(Position.X), math.floor(Position.Y)
                        local xPosition, yPosition = math.floor(x - width * 0.5), math.floor((y - height * 0.5) + (0.5 * scale))

                        -- Обновляем свойства Box
                        Drawings.Box.Size = Vector2.new(width, height)
                        Drawings.Box.Position = Vector2.new(xPosition, yPosition)
                        Drawings.Box.Color = color
                        Drawings.Box.Visible = true

                        -- Обновляем свойства Outline
                        Drawings.BoxOutline.Size = Vector2.new(width, height)
                        Drawings.BoxOutline.Position = Vector2.new(xPosition, yPosition)
                        Drawings.BoxOutline.Visible = true

                        Drawings.BoxOutline.ZIndex = 1
                        Drawings.Box.ZIndex = 2
                    else
                        Drawings.Box.Visible = false
                        Drawings.BoxOutline.Visible = false
                    end
                else
                    Drawings.Box.Visible = false
                    Drawings.BoxOutline.Visible = false
                end
            else
                Drawings.Box.Visible = false
                Drawings.BoxOutline.Visible = false
            end
        end)
    end

    coroutine.wrap(UpdateESP)()
    
    -- Очистка при выходе игрока
    player.AncestryChanged:Connect(function(_, parent)
        if not parent then
            if ESPConnection then
                ESPConnection:Disconnect()
            end
            for _, drawing in pairs(Drawings) do
                drawing:Remove()
            end
        end
    end)
end

-- Обработка существующих игроков
for _, player in ipairs(PlayerService:GetPlayers()) do
    if player ~= LocalPlayer then
        coroutine.wrap(ESP)(player)
    end
end

-- Обработка новых игроков
PlayerService.PlayerAdded:Connect(function(player)
    coroutine.wrap(ESP)(player)
end)

-- Обновление цветов при смене команды
Teams.TeamChanged:Connect(function()
    -- При смене команды нужно перезагрузить ESP для всех игроков
    -- (в реальной реализации нужно аккуратно обновить цвета, а не пересоздавать)
end)
